<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>meetimer</title>
		<link href="css/popup.css" rel="stylesheet" type="text/css" />
		<link href="css\jquery-ui.css" rel="stylesheet" type="text/css" />
		<link href="http://js.t.sinajs.cn/t3//style/css/common/card.css?version=20110824" type="text/css" rel="stylesheet">
		<script type="text/javascript" src="js/ls.js"></script>
		<script type="text/javascript" src="js/jquery.js"></script>
		<script type="text/javascript" src="js/jquery-ui.js"></script>
		<script type="text/javascript" src="js/background.js"></script>
		<script type="text/javascript" src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js?appkey=3215313563"></script>
		<script type="text/javascript">
			Group.initGroup();
			init();
			//get all the group and show them in the list
			function fillGroupList() {
				var groups = Group.getGroupArray();
				$('#groups').empty();
				for(var i=0; i<groups.length; i++) {
					var val = groups[i];
					$("ul.template.groups-list").children().clone().appendTo('#groups')
					.find('input[type=text]').val(val).data('oldname', val);
				}
			}

			function fillGroupedList(list, groupName, grouped) {
				if(list.length == 0)
					return;
				list.sort(createComparisonFunction('time'));
				var totaltime = Statistics2.gettimeingroup(list);
				$('ul.template.domain-list').children().clone().addClass(groupName).appendTo('#domain-list')
				.find('span.group-name').text(groupName).end()
				.find('span.group-time').text(formattime(totaltime));
				for(var i=0; i<list.length; i++) {
					if(parseInt(list[i].time) > 0)
						$('ul.template.group-domain').children().clone().appendTo('#domain-list li.'+groupName+' ul')
						.find('span.domain-name').text(list[i].domain).end()
						.find('span.domain-time').text(formattime(list[i].time));
					if(grouped != undefined)
						grouped[list[i].domain] = 1;
					else {
						if(list[i].time < 120 && i > 20) break;
					}
				}
			}

			function fillchecks() {
				var domaingroup = Group.getAllDomainGroups();
				$('#domain-list>li>ul>li').each( function(n) {
					var domainurl = $('span.domain-name', this).text();
					if(domaingroup[domainurl] && domaingroup[domainurl].length>0)
						$('<span class="checks"/>').html('<span>' + domaingroup[domainurl].join(',') + '</span>').appendTo(this);
					else
						$('<span class="checks"/>').html('<span>ungrouped</span>').appendTo(this);
				});
			}
			function checkGroupName(val) {
				var p1 = /^[\u4e00-\u9fa5\w]+$/;
				if(p1.test(val.trim())) {
					val = val.trim();
					return val;
				}
				return '';
			}
			function showError(text) {
				$('#group div:first-child').append('<p class="error">' + text + '</p>');
			}
			function hideError() {
				$('#group div:first-child .error').remove();
			}
			
			function clone_wb_btn() {
				$('#wb_connect_btn').remove();
				var bgPage = chrome.extension.getBackgroundPage();
				var btn = bgPage.document.getElementById('wb_connect_btn');
				$(document.body).prepend($(btn).clone());
			}
			var WB = chrome.extension.getBackgroundPage().WB2;
			var sae_login = chrome.extension.getBackgroundPage().sae_login;
			$(function() {
				
				chrome.extension.onRequest.addListener(function(request) {
					if(request.name === 'login_pop') {
						console.log(request.name);
						clone_wb_btn();
					} else if(request.name === 'logout_pop') {
						console.log(request.name);
						$("#wb_connect_btn").html('<img src="css/images/240.png" />');
					}
				});
				/*
				if(WB.checkLogin()) {
					$("#wb_connect_btn").text('退出');
				} else {
					$("#wb_connect_btn").html('<img src="css/images/240.png" />');
				}
				*/
				clone_wb_btn();
				// login();
				$('#wb_connect_btn').live('click', function(e) {
					// console.log(WB.checkLogin());
					if(!WB.checkLogin()) {
					    chrome.extension.sendRequest({name: "login_bg"});
					}
					/*
					if(WB.checkLogin())  {
						chrome.extension.sendRequest({name: "logout_bg"});
						//$("#wb_connect_btn").html('<img src="css/images/240.png" />');
						//clone_wb_btn();
					} else {
						chrome.extension.sendRequest({name: "login_bg"});
					}
					*/
				});
				$('.weibo_widget_connect_disconnect').live('click', function() {
					console.log("done!!!");
					console.log(this);
					if(WB.checkLogin())  {
						chrome.extension.sendRequest({name: "logout_bg"});
						//$("#wb_connect_btn").html('<img src="css/images/240.png" />');
						//clone_wb_btn();
					}
				});
				
				$('#tabset').tabs();
				fillGroupList();
				//create group
				$('[name="createbtn"]').click( function(event) {
					hideError();
					var val = checkGroupName($("[name='groupname']").val());
					if(val !== '' && val != "ungrouped" && Group.createGroup(val)) {
						$("ul.template.groups-list").children().clone().appendTo('#groups')
						.find('input[type=text]').val(val).data('oldname', val);
						$('#time-selector select').change();
					} else if(val === '') {
						showError('please do not input special chars.');
					} else {
						showError('group ' + val + ' exists');
					}
				});
				//delete group
				$('button.delete').live('click', function() {
					var unit = $(this).closest('li');
					var name = unit.find('[type=text]').val();
					unit.remove();
					Group.deleteGroup(name);
					$('#time-selector select').change();
				});
				//rename group
				$('button.rename').live('click', function() {
					hideError();
					var oldname = $(this).prev('[type=text]').data('oldname');
					var newname = checkGroupName($(this).prev('[type=text]').val().trim());
					if(newname !== '' && newname != 'ungrouped' && Group.renameGroup(oldname, newname)) {
						$(this).prev('[type=text]').data('oldname', newname);
					}
					else if(newname === '') {
						showError('please do not input special chars.');
					} else {
						showError('group ' + newname + ' exists');
					}
					fillGroupList();
					$('#time-selector select').change();
				});
				$('#time-selector select').change( function(event) {
					$('#domain-list').empty();
					var time = $(':selected', this).val();
					//var obj = jQuery.extend(true, {}, window.time_tracker);
					var groups = Group.getGroupArray(), grouped = {};
					
					for(var i=0; i<groups.length; i++) {
						var list = Statistics2.get(time, groups[i]);
						fillGroupedList(list, groups[i], grouped);
					}
					
					var ungrouped = [];
					var all = Statistics2.get(time);
					for(var i=0; i<all.length; i++)
						if(!grouped[all[i].domain])
							ungrouped.push(all[i]);
					ungrouped.sort();
					fillGroupedList(ungrouped, 'ungrouped');
					//fillchecks();
				}).change();
				$('ul#domain-list>li>span.group-name').live('click', function(event) {
					$(this).nextAll('ul').toggle();
					if($(this).nextAll('ul').is(':hidden'))
						$(this).switchClass('up-arrow', 'down-arrow');
					else
						$(this).switchClass('down-arrow', 'up-arrow');
				});
				$('#domain-list>li>ul>li')
				.live('mouseenter', function(event) {
					var groups = Group.getGroupArray();
					if(groups.length == 0) return;
					var text = $(this).text();
					var domainname = $('span.domain-name', this).text();
					$('ul.template.group-checks').clone().removeClass('template').appendTo(this);
					for(var i=0; i<groups.length; i++) {
						$('<li><input type="checkbox" /><label /></li>').appendTo('#domain-list ul.group-checks')
						.find('input[type=checkbox]')
						.attr('id', domainname + '|' + groups[i])
						.attr('checked', Group.isDomainInGroup(domainname, groups[i]) ? true : false).end()
						.find('label').text(groups[i]).attr('for', domainname + '|' + groups[i]);
					}
				})
				.live('mouseleave', function(event){
					$('ul.group-checks', this).remove();
				});
				$('#domain-list ul.group-checks input[type=checkbox]').live('click', function(event) {
					event.stopPropagation();
					var domainname = this.id.split('|')[0],
					groupname = this.id.split('|')[1],
					currentgroup = $(this).closest('#domain-list>li').find('span.group-name').text();
					if(!this.checked) {
						Group.deleteDomainFromGroup(domainname, groupname);
					} else if(this.checked) {
						Group.addDomainToGroup(domainname, groupname);
					}

					$('#time-selector select').change();
				});
				$('button[name="sync"]').click( function() {
					$(this).addClass('loading');
					$(document).queue(function() {
					    sae_login(function() {$(document).dequeue();});
					    console.log('login!')
					});
					$(document).queue(function() {
					    sync_data(function(result) {
						    if(result) {
							    $('<p id="info" class="info">sync successfully!</p>').hide().insertBefore('#domain-list').slideDown(300).delay(1000).slideUp(300);
							    $('#time-selector select').change();
						    } else {
							    $('<p id="info" class="error">failed in sync, please sync sooner.</p>').hide().insertBefore('#domain-list').slideDown(300).delay(1000).slideUp(300);
						    }
						    $('button[name="sync"]').removeClass('loading');
						    $(document).dequeue();
					    });
					});
				});
			});
		</script>
		
	</head>
	<body>
		<a id="wb_connect_btn">
			<img src="css/images/240.png" />
		</a>
		<div class="container">
			<div id="tabset">
				<ul>
					<li>
						<a href="#show-lists">Time Lists</a>
					</li>
					<li>
						<a href="#group">Group Options</a>
					</li>
				</ul>
				<div id="group">
					<div>
						<input type="text" id="groupname" name="groupname" />
						<input type="button" name="createbtn" value="Create Group" />
					</div>
					<ul id="groups">
					</ul>
				</div>
				<div id="show-lists">
					<div id="time-selector">
						<select name="time">
							<option value="today">today</option>
							<option value="yesterday">yesterday</option>
							<option value="thisweek">thisweek</option>
							<option value="lastweek">lastweek</option>
							<option value="total">total</option>
						</select>
						<button type="button" name="sync">
							synchronize
						</button>
					</div>
					<ul id="domain-list">
					</ul>
				</div>
			</div>
		</div>
		<!-- templates -->
		<ul class='template domain-list'>
			<li>
				<span class='group-name up-arrow'></span>
				<span class='group-time'></span>
				<ul>
				</ul>
			</li>
		</ul>
		<ul class='template group-domain'>
			<li>
				<span class='domain-name'></span>
				<span class='domain-time'></span>
			</li>
		</ul>
		<ul class='template groups-list'>
			<li>
				<input type="text" name="groupname" />
				<button type="button" class='rename'>
					rename
				</button>
				<button type="button" class='delete'>
					X
				</button>
			</li>
		</ul>
		<ul class='template group-checks'>
		</ul>
	</body>
</html>
