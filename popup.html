<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>meetimer</title>
		<link href="css/popup.css" rel="stylesheet" type="text/css" />
		<link href="css/jquery-ui-1.8.13.custom.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" src="js/global.js"></script>
		<script type="text/javascript" src="js/popup.js"></script>
		<script type="text/javascript" src="js/jquery.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
		<script type="text/javascript" src="js/background.js"></script>
		<script type="text/javascript">
			init();
			initGroup();
			//get all the group and show them in the list
			function fillGroupList() {
				var groups = getGroupArray();
				for(var i=0; i<groups.length; i++) {
					var val = groups[i];
					$("ul.template.groups-list").children().clone().appendTo('#groups')
					.find('input[type=text]').val(val).data('oldname', val);
				}
			}

			function fillGroupedList(list, groupName, grouped) {
				if(list.length == 0)
					return;
				list.sort(createComparisonFunction('time'));
				var totaltime = Statistics.gettimeingroup(list);
				$('ul.template.domain-list').children().clone().addClass(groupName).appendTo('#domain-list')
				.find('span.group-name').text(groupName).end()
				.find('span.group-time').text(formattime(totaltime));
				for(var i=0; i<list.length; i++) {
					if(list[i].time > 0)
						$('ul.template.group-domain').children().clone().appendTo('#domain-list li.'+groupName+' ul')
						.find('span.domain-name').text(list[i].domain).end()
						.find('span.domain-time').text(formattime(list[i].time));
					if(grouped != undefined)
						grouped[list[i].domain] = 1;
				}
			}

			function fillchecks() {
				var domaingroup = getAllDomainGroups();
				$('#domain-list>li>ul>li').each( function(n) {
					var domainurl = $('span.domain-name', this).text();
					if(domaingroup[domainurl] && domaingroup[domainurl].length>0)
						$('<span class="checks"/>').html('<span>' + domaingroup[domainurl].join(',') + '</span>').appendTo(this);
					else
						$('<span class="checks"/>').html('<span>ungrouped</span>').appendTo(this);
				});
			}

			$( function() {
				$('#tabset').tabs();

				fillGroupList();
				//create group
				$('[name="createbtn"]').click( function(event) {
					var val = $("[name='groupname']").val();
					if(val && createGroup(val)) {
						$("ul.template.groups-list").children().clone().appendTo('#groups')
						.find('input[type=text]').val(val).data('oldname', val);
					} else if(!createGroup(val)) {
						alert('group ' + val + ' exists');
					}
				});
				//delete group
				$('button.delete').live('click', function() {
					var unit = $(this).closest('li');
					var name = unit.find('[type=text]').val();
					unit.remove();
					deleteGroup(name);
				});
				//rename group
				$('button.rename').live('click', function() {
					var oldname = $(this).prev('[type=text]').data('oldname');
					var newname = $(this).prev('[type=text]').val();
					renameGroup(oldname, newname);
					$(this).prev('[type=text]').data('oldname', newname);
				});
				$('#time-selector select').change( function(event) {
					$('#domain-list').empty();
					var time = $(':selected', this).val();
					//var obj = jQuery.extend(true, {}, window.time_tracker);
					var groups = getGroupArray(), grouped = {};
					
					for(var i=0; i<groups.length; i++) {
						var list = Statistics.get(time, groups[i]);
						fillGroupedList(list, groups[i], grouped);
					}
					var ungrouped = [];
					var all = Statistics.get(time);
					for(var i=0; i<all.length; i++)
						if(!grouped[all[i].domain])
							ungrouped.push(all[i]);
					ungrouped.sort();
					fillGroupedList(ungrouped, 'ungrouped');
					//fillchecks();
				}).change();
				$('ul#domain-list>li>span.group-name').live('click', function(event) {
					$(this).nextAll('ul').toggle();
					if($(this).nextAll('ul').is(':hidden'))
						$(this).switchClass('up-arrow', 'down-arrow');
					else
						$(this).switchClass('down-arrow', 'up-arrow');
				});
				$('#domain-list>li>ul>li')
				.live('click', function(event) {
					var groups = getGroupArray();
					$('#domain-list div.group-checks').remove();
					var text = $(this).text();
					var domainname = $('span.domain-name', this).text();
					$('div.template.group-checks').clone().removeClass('template').appendTo(this);
					for(var i=0; i<groups.length; i++) {
						$('<li><input type="checkbox" /><label /></li>').appendTo('#domain-list div.group-checks ul.checks-list')
						.find('input[type=checkbox]')
						.attr('id', domainname + '|' + groups[i])
						.attr('checked', isDomainInGroup(domainname, groups[i]) ? true : false).end()
						.find('label').text(groups[i]).attr('for', domainname + '|' + groups[i]);
					}
				});
				//here is the 'cancel' button event action
				$('button[name="new-group-cancel"]').live('click', function(e) {
					e.stopPropagation();
					$(this).closest('div.group-checks').remove();
				});
				$('#domain-list ul.checks-list input[type=checkbox]').live('click', function(event) {
					event.stopPropagation();
					var domainname = this.id.split('|')[0],
					groupname = this.id.split('|')[1],
					currentgroup = $(this).closest('#domain-list>li').find('span.group-name').text();
					if(!this.checked) {
						deleteDomainFromGroup(domainname, groupname);
						//var groups = getDomainGroups(domainname);
						//if(groups.length == 0)

						//$(this).closest('#domain-list>li>ul>li').remove();
					} else if(this.checked) {
						addDomainToGroup(domainname, groupname);
						/*if(currentgroup == 'ungrouped')
						 $(this).closest('#domain-list>li li').appendTo('ul#domain-list li.'+groupname + '<ul');
						 else
						 $(this).closest('#domain-list>li li').clone().appendTo('ul#domain-list li.'+groupname + '<ul');
						 $(this).closest('div.group-checks').remove();*/
					}

					$('#time-selector select').change();
				});
				$('button[name="clear"]').click( function() {
					clearTime();
					$('#time-selector select').change();
				});
				/*
				 .bind('blur', function() {
				 this.open = false;
				 $('.group-checks', this).remove();
				 });*/
			});
		</script>
	</head>
	<body>
		<div class="container">
			<div id="tabset">
				<ul>
					<li>
						<a href="#show-lists">Time Lists</a>
					</li>
					<li>
						<a href="#group">Group Options</a>
					</li>
				</ul>
				<div id="group">
					<div>
						<input type="text" id="groupname" name="groupname" />
						<input type="button" name="createbtn" value="Create Group" />
					</div>
					<ul id="groups">
					</ul>
				</div>
				<div id="show-lists">
					<div id="time-selector">
						<select name="time">
							<option value="today">today</option>
							<option value="yesterday">yesterday</option>
							<option value="thisweek">thisweek</option>
							<option value="lastweek">lastweek</option>
							<option value="total">total</option>
						</select>
						<button type="button" name="clear">
							Clear All
						</button>
					</div>
					<ul id="domain-list">
					</ul>
				</div>
			</div>
		</div>
		<!-- templates -->
		<ul class='template domain-list'>
			<li>
				<span class='group-name up-arrow'></span>
				<span class='group-time'></span>
				<ul>
				</ul>
			</li>
		</ul>
		<ul class='template group-domain'>
			<li>
				<span class='domain-name' title="click to edit groups"></span>
				<span class='domain-time'></span>
			</li>
		</ul>
		<ul class='template groups-list'>
			<li>
				<input type="text" name="groupname" />
				<button type="button" class='rename'>
					rename
				</button>
				<button type="button" class='delete'>
					X
				</button>
			</li>
		</ul>
		<div class='template group-checks'>
			<ul class="checks-list">
			</ul>
			<div class='checks-add-form'>
				<button type="button" name="new-group-cancel">
					cancel
				</button>
			</div>
		</div>
	</body>
</html>
